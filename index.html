<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Chat</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Markdown & Highlight -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --bg-color: #131314;
            --sidebar-bg: #0D0D0E;
            --input-bg: #1E1F22;
            --user-msg-bg: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            --text-color: #E3E3E3;
            --text-muted: #9ca3af;
            --border-color: rgba(255, 255, 255, 0.06);
            --sidebar-width: 280px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f10 0%, #1a1a1d 50%, #0f0f10 100%);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #0a0a0b 0%, #111113 100%);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 2000;
        }

        #sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 1.5rem 1.5rem 1.5rem 5rem;
            /* Increased to 5rem for safety */
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .new-chat-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.06) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-color);
            padding: 0.8rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            width: calc(100% - 2rem);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 1rem;
        }

        .new-chat-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.12) 100%);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-item {
            padding: 0.35rem 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
        }

        .chat-item.active {
            background: rgba(255, 255, 255, 0.08);
            color: white;
        }

        .chat-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .delete-btn {
            opacity: 0.6;
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.1);
        }

        .chat-item:hover .delete-btn {
            opacity: 1;
        }

        /* Main Content */
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100%;
            position: relative;
        }

        body.sidebar-closed #main {
            margin-left: 0;
        }

        /* Toggle Button */
        #toggle-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 2001;
            /* Above sidebar */
            background: rgba(30, 30, 34, 0.8);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            width: 44px;
            height: 44px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: left 0.3s ease;
        }

        #toggle-btn:hover {
            color: white;
            background: rgba(40, 40, 45, 1);
        }

        /* Header */
        header {
            text-align: center;
            padding: 2rem 1rem;
        }

        h1 {
            font-size: 1.8rem;
            margin: 0;
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Chat Area */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 50px 50px 8rem 50px;
            /* 50px Top/Left/Right */
            scroll-behavior: smooth;
            max-width: 100%;
            /* Use full width */
            margin: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .message {
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message-content {
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            max-width: 80%;
            line-height: 1.6;
            position: relative;
        }

        .message.user .message-content {
            background: var(--user-msg-bg);
            color: white;
            border-radius: 1rem 1rem 0.25rem 1rem;
            box-shadow: 0 2px 12px rgba(37, 99, 235, 0.3) !important;
        }

        .message.assistant .message-content {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: #e5e5e5;
            border-radius: 0.5rem 1rem 1rem 1rem;
        }

        /* Markdown Styles */
        .message-content pre {
            background: #1a1a1e;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message-content code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }

        .message-content p {
            margin: 0.5rem 0;
        }

        .message-content p:first-child {
            margin-top: 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        /* Input Area */
        #input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            background: linear-gradient(to top, #0f0f10 80%, transparent);
            display: flex;
            justify-content: center;
        }

        .input-wrapper {
            max-width: 850px;
            width: 100%;
            background: var(--input-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transition: border-color 0.2s;
            position: relative;
        }

        .input-wrapper:focus-within {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(59, 130, 246, 0.15);
        }

        .model-select {
            background: #3a3d45;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 8px 12px;
            font-size: 0.8rem;
            margin-right: 12px;
            outline: none;
            cursor: pointer;
            max-width: 220px;
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: #f5f5f5;
            font-size: 1rem;
            resize: none;
            height: 24px;
            max-height: 200px;
            padding: 8px 0;
            font-family: inherit;
            outline: none;
        }

        #send-btn {
            background: var(--user-msg-bg);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            margin-left: 8px;
        }

        #send-btn:hover {
            transform: scale(1.05);
        }

        #send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading indicator */
        .typing-indicator {
            display: inline-block;
            margin-top: 4px;
        }

        .typing-indicator span {
            display: inline-block;
            width: 4px;
            height: 4px;
            background-color: #aaa;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Settings Button */
        #settings-btn {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 2001;
            background: rgba(30, 30, 34, 0.8);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            width: 44px;
            height: 44px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        #settings-btn:hover {
            color: white;
            background: rgba(40, 40, 45, 1);
            transform: rotate(30deg);
        }

        /* Settings Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: #16161e;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            width: 90%;
            max-width: 620px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
            animation: modalIn 0.25s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
            color: #fff;
        }

        .modal-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .storage-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(99, 102, 241, 0.12);
            color: #818cf8;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .model-disk-size {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 8px;
            background: rgba(99, 102, 241, 0.08);
            color: #818cf8;
            white-space: nowrap;
            margin-left: 4px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.4rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.06);
        }

        /* Tabs */
        .modal-tabs {
            display: flex;
            gap: 4px;
            padding: 16px 24px 0;
        }

        .modal-tab {
            padding: 8px 18px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .modal-tab:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.04);
        }

        .modal-tab.active {
            background: rgba(79, 138, 255, 0.1);
            color: #4f8aff;
            border-color: rgba(79, 138, 255, 0.25);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px 24px;
        }

        /* Installed model row */
        .installed-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .installed-item:hover {
            border-color: rgba(255, 255, 255, 0.12);
        }

        .installed-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .installed-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #e8e8f0;
        }

        .installed-tag {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .installed-category {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cat-general {
            background: rgba(79, 138, 255, 0.12);
            color: #4f8aff;
        }

        .cat-code {
            background: rgba(167, 139, 250, 0.12);
            color: #a78bfa;
        }

        .del-model-btn {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.2);
            color: #f87171;
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .del-model-btn:hover {
            background: rgba(248, 113, 113, 0.2);
            border-color: #f87171;
        }

        .del-model-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Add model catalog */
        .catalog-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .catalog-item:hover {
            border-color: rgba(255, 255, 255, 0.12);
        }

        .catalog-info {
            flex: 1;
            margin-right: 12px;
        }

        .catalog-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #e8e8f0;
        }

        .catalog-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
            line-height: 1.4;
        }

        .catalog-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
            min-width: 120px;
        }

        .catalog-variant-select {
            background: #2a2a35;
            color: #e8e8f0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-family: inherit;
            cursor: pointer;
            outline: none;
            width: 100%;
        }

        .add-model-btn {
            background: rgba(52, 211, 153, 0.1);
            border: 1px solid rgba(52, 211, 153, 0.2);
            color: #34d399;
            padding: 5px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.78rem;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
        }

        .add-model-btn:hover {
            background: rgba(52, 211, 153, 0.2);
            border-color: #34d399;
        }

        .add-model-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .add-model-btn.installing {
            background: rgba(79, 138, 255, 0.1);
            border-color: rgba(79, 138, 255, 0.3);
            color: #4f8aff;
        }

        .add-model-btn.done {
            background: rgba(52, 211, 153, 0.15);
            border-color: rgba(52, 211, 153, 0.3);
            color: #34d399;
        }

        .catalog-installed-badge {
            font-size: 0.7rem;
            color: #34d399;
            font-weight: 600;
            padding: 4px 10px;
            background: rgba(52, 211, 153, 0.08);
            border-radius: 6px;
            text-align: center;
            width: 100%;
        }

        .cancel-model-btn {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.25);
            color: #fbbf24;
            padding: 5px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.78rem;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
            margin-top: 4px;
        }

        .cancel-model-btn:hover {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
        }

        .modal-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .modal-empty .icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .section-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin: 16px 0 8px;
            font-weight: 600;
        }

        .section-label:first-child {
            margin-top: 0;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin: 0; font-size: 1.1rem; color: #fff;">Chats</h2>
        </div>
        <button class="new-chat-btn" onclick="startNewChat()">
            ‚ú® New Chat
        </button>
        <div class="chat-list" id="chat-list">
            <!-- Chat items will be injected here -->
        </div>
    </div>

    <!-- Main App -->
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2>‚öôÔ∏è Model Settings</h2>
                    <span class="storage-badge" id="total-storage"></span>
                </div>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" id="tab-installed" onclick="switchTab('installed')">Installed</button>
                <button class="modal-tab" id="tab-add" onclick="switchTab('add')">Add Models</button>
            </div>
            <div class="modal-body">
                <div id="panel-installed"></div>
                <div id="panel-add" style="display:none"></div>
            </div>
        </div>
    </div>

    <div id="main">
        <button id="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
        <button id="settings-btn" onclick="openSettings()">‚öô</button>

        <div id="chat-container">
            <!-- Messages will be injected here -->
            <div id="empty-state" class="empty-chat"
                style="display: none; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; margin-top: 10vh;">
                <div style="font-size: 4rem; opacity: 0.5;">üí¨</div>
                <h2 style="color: #e5e5e5; margin: 0;">How can I help you today?</h2>
                <p style="color: #6b7280; margin: 0;">Start a conversation below.</p>
            </div>
        </div>

        <div id="input-area">
            <div class="input-wrapper">
                <select class="model-select" id="model-select">
                    <!-- Populated dynamically from /api/models -->
                </select>
                <textarea id="user-input" placeholder="Message Ollama..." rows="1" oninput="autoResize(this)"
                    onkeydown="handleEnter(event)"></textarea>
                <button id="send-btn" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentChatId = null;
        let messages = [];
        let sidebarVisible = true;

        // Config
        marked.setOptions({
            highlight: function (code, lang) {
                const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                return highlight.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        // Load available models into the dropdown
        async function loadModels() {
            try {
                const res = await fetch('/api/models');
                const data = await res.json();
                const select = document.getElementById('model-select');
                select.innerHTML = '';
                data.models.forEach((m, i) => {
                    const opt = document.createElement('option');
                    opt.value = m.key;
                    // Show model name with category in brackets
                    const category = m.key.startsWith('code') ? 'Coder' : 'General';
                    opt.textContent = `${m.label.replace(/^[^\w]+/, '')} (${category})`;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error('Failed to load models:', err);
                // Fallback
                const select = document.getElementById('model-select');
                select.innerHTML = '<option value="general">Qwen 3 (General)</option><option value="code">Qwen 2.5 Coder (Coder)</option>';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadModels();
            loadChats();
            startNewChat();

            // Focus input
            document.getElementById('user-input').focus();
        });

        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            const btn = document.getElementById('toggle-btn');

            sidebarVisible = !sidebarVisible;
            document.body.classList.toggle('sidebar-closed');

            if (sidebarVisible) {
                sidebar.classList.remove('hidden');
                btn.innerHTML = '‚ò∞';
            } else {
                sidebar.classList.add('hidden');
                btn.innerHTML = '‚¨Ö'; // Arrow creates visual cue to bring it back (or just keep hamburger)
                // Actually, if it's closed, maybe user wants to click hamburger to open.
                // In my python version I used left arrow when closed?? No, backward. 
                // Let's stick to Hamburger '‚ò∞' always? Or Close '‚úï'?
                // Python version code: "‚ò∞" if st.session_state.sidebar_visible else "‚¨Ö"
                // If visible -> Hamburger makes sense to close?
                // Actually usually: Hamburger -> Opens. Close/Back -> Closes.
                // If sidebar is visible, button should perhaps be "Close"?
                // Let's keep it simple: Hamburger toggles.
                btn.innerHTML = sidebarVisible ? '‚ò∞' : '‚û°';
            }
        }

        // Auto resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // Handle Enter key
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // API Calls
        async function loadChats() {
            try {
                const res = await fetch('/api/chats');
                const chats = await res.json();
                renderChatList(chats);
            } catch (err) {
                console.error('Failed to load chats:', err);
            }
        }

        function renderChatList(chats) {
            const container = document.getElementById('chat-list');
            container.innerHTML = '';

            if (chats.length === 0) {
                container.innerHTML = `
                    <div style="padding:2rem 1rem; color:var(--text-muted); text-align:center; opacity:0.6;">
                        <div style="font-size:1.5rem; margin-bottom:0.5rem;">üì≠</div>
                        <div style="font-size:0.9rem;">No saved chats</div>
                    </div>`;
                return;
            }

            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                div.onclick = () => loadChat(chat.id);

                div.innerHTML = `
                    <div class="chat-title">${chat.title || 'Untitled'}</div>
                    <button type="button" class="delete-btn" onclick="deleteChat(event, '${chat.id}')">üóë</button>
                `;
                container.appendChild(div);
            });
        }

        async function loadChat(id) {
            try {
                const res = await fetch(`/api/chats/${id}`);
                const data = await res.json();

                currentChatId = data.id;
                messages = data.messages || [];
                document.getElementById('model-select').value = data.model;

                renderMessages();
                loadChats(); // Refresh active state
            } catch (err) {
                console.error('Failed to load chat:', err);
            }
        }

        async function startNewChat() {
            currentChatId = null;
            messages = [];
            renderMessages();

            // Check headers, maybe simple UUID client side or wait for first message save
            // We'll wait for first message to save
            loadChats(); // clear active selection
        }

        async function deleteChat(e, id) {
            e.stopPropagation();
            e.preventDefault();
            if (!confirm('Delete chat?')) return;

            try {
                await fetch(`/api/chats/${id}`, { method: 'DELETE' });
                if (currentChatId === id) startNewChat();
                loadChats();
            } catch (err) {
                console.error('Failed to delete chat:', err);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const model = document.getElementById('model-select').value;

            if (!text) return;

            // Add user message
            messages.push({ role: 'user', content: text });
            input.value = '';
            input.style.height = 'auto'; // Reset height
            renderMessages();

            // Create assistant placeholder
            const assistantMsgIndex = messages.push({ role: 'assistant', content: '' }) - 1;
            renderMessages(); // Render with empty assistant bubble

            // UI state
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;

            try {
                // Prepare request
                const payload = {
                    model: model, // server expects model_key
                    messages: messages.slice(0, -1) // Request with history (excluding empty placeholder)
                };

                // Use fetch to post to stream endpoint
                // Wait, server expects `ChatRequest` with `model_key` and `messages`
                // My payload format needs to match
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_key: model,
                        messages: payload.messages
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                let assistantContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    assistantContent += chunk;
                    messages[assistantMsgIndex].content = assistantContent;

                    // Update UI incrementally
                    updateLastMessage(assistantContent);
                }

                // Save Chat after completion
                await saveCurrentChat(model);

            } catch (err) {
                messages[assistantMsgIndex].content = '‚ö†Ô∏è Error: ' + err.message;
                renderMessages();
            } finally {
                input.disabled = false;
                document.getElementById('send-btn').disabled = false;
                input.focus();
            }
        }

        async function saveCurrentChat(model) {
            // If chat doesn't exist or we just added messages
            const payload = {
                id: currentChatId, // if null, server generates
                model: model,
                messages: messages,
                title: null // server generates
            };

            try {
                const res = await fetch('/api/chats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                currentChatId = data.id;
                loadChats(); // refresh list
            } catch (err) {
                console.error('Failed to save chat', err);
            }
        }

        function renderMessages() {
            const container = document.getElementById('chat-container');
            const emptyState = document.getElementById('empty-state');

            // Remove all messages but keep empty state div
            // Easier to just rebuild
            container.innerHTML = '';
            container.appendChild(emptyState);

            if (messages.length === 0) {
                emptyState.style.display = 'flex';
                return;
            } else {
                emptyState.style.display = 'none';
            }

            messages.forEach((msg, index) => {
                const div = document.createElement('div');
                div.className = `message ${msg.role}`;
                div.id = `msg-${index}`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                if (msg.role === 'assistant' && !msg.content) {
                    contentDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
                } else {
                    contentDiv.innerHTML = marked.parse(msg.content);
                }

                div.appendChild(contentDiv);
                container.appendChild(div);
            });

            scrollToBottom();
        }

        function updateLastMessage(content) {
            const index = messages.length - 1;
            const msgDiv = document.getElementById(`msg-${index}`);
            if (msgDiv) {
                const contentDiv = msgDiv.querySelector('.message-content');
                contentDiv.innerHTML = marked.parse(content);
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SETTINGS MODAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const MODEL_CATALOG = {
            general: [
                { name: "Qwen 3", desc: "Next-Gen General. Rivals 7B models in logic.", variants: [{ tag: "qwen3:0.6b", ram: "~600MB", label: "Low usage" }, { tag: "qwen3:1.7b", ram: "~1.7GB", label: "High usage" }] },
                { name: "Granite 4", desc: "Hybrid Mamba/Transformer. Extremely fast.", variants: [{ tag: "granite4-tiny:1b", ram: "~1GB", label: "Low usage" }, { tag: "granite4:3b", ram: "~3GB", label: "High usage" }] },
                { name: "Gemma 3", desc: "Multimodal. Image + Text understanding. 32k context.", variants: [{ tag: "gemma3:1b", ram: "~1GB", label: "Low usage" }, { tag: "gemma3:4b", ram: "~4GB", label: "High usage" }] },
                { name: "Gemma 3n", desc: "Mobile Optimized. Selective parameter activation.", variants: [{ tag: "gemma3n:e2b", ram: "~2GB", label: "Low usage" }, { tag: "gemma3n:e4b", ram: "~4GB", label: "High usage" }] },
                { name: "Ministral 3", desc: "Edge Agent. Function calling. 128k context.", variants: [{ tag: "ministral:3b", ram: "~3GB", label: "Standard" }] },
                { name: "Llama 3.2", desc: "Robust edge AI standard. 128k context, tool use.", variants: [{ tag: "llama3.2:1b", ram: "~1GB", label: "Low usage" }, { tag: "llama3.2:3b", ram: "~3GB", label: "High usage" }] },
                { name: "Granite 3.2 Vision", desc: "Best for docs, charts, tables, invoices.", variants: [{ tag: "granite3.2-vision:2b", ram: "~2GB", label: "Standard" }] },
                { name: "DeepSeek R1", desc: "Chain-of-Thought reasoning for logic/math.", variants: [{ tag: "deepseek-r1:1.5b", ram: "~1.5GB", label: "Standard" }] },
                { name: "DeepSeek OCR", desc: "Converts images of text/PDFs into Markdown.", variants: [{ tag: "deepseek-ocr:3b", ram: "~3GB", label: "Standard" }] },
                { name: "Granite 3.1 MoE", desc: "Mixture of Experts. Very low latency.", variants: [{ tag: "granite3.1-moe:1b", ram: "~1GB", label: "Low usage" }, { tag: "granite3.1-moe:3b", ram: "~3GB", label: "High usage" }] },
                { name: "Granite 3.1 Dense", desc: "Optimized for enterprise tasks and RAG.", variants: [{ tag: "granite3-dense:2b", ram: "~2GB", label: "Standard" }] },
                { name: "Phi-2", desc: "Microsoft's small model. Good logic, 4k context.", variants: [{ tag: "phi:2.7b", ram: "~2.7GB", label: "Standard" }] },
                { name: "Moondream 2", desc: "Very fast image description. Runs on Pi.", variants: [{ tag: "moondream:1.4b", ram: "~1.4GB", label: "Standard" }] },
                { name: "SmolLM", desc: "High-quality synthetic data. Creative writing.", variants: [{ tag: "smollm:360m", ram: "~360MB", label: "Low usage" }, { tag: "smollm:1.7b", ram: "~1.7GB", label: "High usage" }] },
                { name: "TinyLlama", desc: "The hello world of LLMs. Any hardware.", variants: [{ tag: "tinyllama:1.1b", ram: "~1.1GB", label: "Standard" }] },
            ],
            code: [
                { name: "Qwen 2.5 Coder", desc: "King of Small Coders. GPT-4 level. 90+ languages.", variants: [{ tag: "qwen2.5-coder:0.5b", ram: "~500MB", label: "Low usage" }, { tag: "qwen2.5-coder:1.5b", ram: "~1.5GB", label: "Mid usage" }, { tag: "qwen2.5-coder:3b", ram: "~3GB", label: "High usage" }] },
                { name: "Stable Code", desc: "Autocomplete specialist. Fill-In-The-Middle.", variants: [{ tag: "stable-code:3b", ram: "~3GB", label: "Standard" }] },
                { name: "DeepSeek Coder", desc: "Lightweight classic. Quick script generation.", variants: [{ tag: "deepseek-coder:1.3b", ram: "~1.3GB", label: "Standard" }] },
                { name: "CodeGemma", desc: "Google's code specialist. Gemma 1 architecture.", variants: [{ tag: "codegemma:2b", ram: "~2GB", label: "Standard" }] },
                { name: "Yi Coder", desc: "Long context coder. 32k window for whole files.", variants: [{ tag: "yi-coder:1.5b", ram: "~1.5GB", label: "Standard" }] },
            ]
        };

        let installedModels = { general: [], code: [] };

        function openSettings() {
            document.getElementById('settings-modal').classList.add('open');
            switchTab('installed');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('open');
            // Refresh the model dropdown in case models changed
            loadModels();
        }

        // Close modal on overlay click
        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeSettings();
        });

        function switchTab(tab) {
            document.getElementById('tab-installed').classList.toggle('active', tab === 'installed');
            document.getElementById('tab-add').classList.toggle('active', tab === 'add');
            document.getElementById('panel-installed').style.display = tab === 'installed' ? 'block' : 'none';
            document.getElementById('panel-add').style.display = tab === 'add' ? 'block' : 'none';

            if (tab === 'installed') loadInstalledModels();
            if (tab === 'add') renderCatalog();
        }

        async function loadInstalledModels() {
            const panel = document.getElementById('panel-installed');
            panel.innerHTML = '<div class="modal-empty"><div class="spinner-small"></div>Loading...</div>';

            try {
                // Fetch installed models and storage info in parallel
                const [instRes, storageRes] = await Promise.all([
                    fetch('/api/setup/installed'),
                    fetch('/api/setup/storage')
                ]);
                installedModels = await instRes.json();
                const storageInfo = await storageRes.json();

                // Update total storage badge
                const badge = document.getElementById('total-storage');
                if (badge) {
                    badge.textContent = storageInfo.total_display ? `üíæ ${storageInfo.total_display}` : '';
                }

                const all = [
                    ...(installedModels.general || []).map(m => ({ ...m, category: 'general' })),
                    ...(installedModels.code || []).map(m => ({ ...m, category: 'code' }))
                ];

                if (all.length === 0) {
                    panel.innerHTML = '<div class="modal-empty"><div class="icon">üì≠</div>No models installed yet.<br>Go to the <b>Add Models</b> tab to get started.</div>';
                    return;
                }

                const generalModels = all.filter(m => m.category === 'general');
                const codeModels = all.filter(m => m.category === 'code');
                let html = '';

                if (generalModels.length > 0) {
                    html += '<div class="section-label">General Models</div>';
                    generalModels.forEach(m => {
                        html += renderInstalledItem(m, storageInfo.models);
                    });
                }
                if (codeModels.length > 0) {
                    html += '<div class="section-label">Coder Models</div>';
                    codeModels.forEach(m => {
                        html += renderInstalledItem(m, storageInfo.models);
                    });
                }

                panel.innerHTML = html;
            } catch (err) {
                panel.innerHTML = '<div class="modal-empty">Failed to load models.</div>';
            }
        }

        function renderInstalledItem(m, storageModels) {
            const catClass = m.category === 'code' ? 'cat-code' : 'cat-general';
            const catLabel = m.category === 'code' ? 'Coder' : 'General';
            const diskInfo = storageModels && storageModels[m.tag];
            const diskSize = diskInfo ? diskInfo.size : '';
            return `
                <div class="installed-item" id="inst-${CSS.escape(m.tag)}">
                    <div class="installed-info">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span class="installed-name">${m.name || m.tag}</span>
                            <span class="installed-category ${catClass}">${catLabel}</span>
                            ${diskSize ? `<span class="model-disk-size">${diskSize}</span>` : ''}
                        </div>
                        <span class="installed-tag">${m.tag}${m.ram ? ' ‚Ä¢ RAM: ' + m.ram : ''}</span>
                    </div>
                    <button class="del-model-btn" id="del-${CSS.escape(m.tag)}" onclick="deleteModel('${m.tag}', '${m.category}')">
                        üóë Remove
                    </button>
                </div>`;
        }

        async function deleteModel(tag, category) {
            if (!confirm(`Remove ${tag}?\nThis will delete the model from your system.`)) return;

            const btn = document.getElementById(`del-${CSS.escape(tag)}`);
            if (btn) { btn.disabled = true; btn.textContent = 'Removing...'; }

            try {
                await fetch('/api/setup/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag, category })
                });

                const item = document.getElementById(`inst-${CSS.escape(tag)}`);
                if (item) {
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(20px)';
                    item.style.transition = 'all 0.3s';
                    setTimeout(() => {
                        item.remove();
                        loadInstalledModels();
                    }, 300);
                }
            } catch (err) {
                alert('Failed to delete model: ' + err.message);
                if (btn) { btn.disabled = false; btn.textContent = 'üóë Remove'; }
            }
        }

        function getInstalledTags() {
            const tags = new Set();
            (installedModels.general || []).forEach(m => tags.add(m.tag));
            (installedModels.code || []).forEach(m => tags.add(m.tag));
            return tags;
        }

        async function renderCatalog() {
            // First refresh installed list
            try {
                const res = await fetch('/api/setup/installed');
                installedModels = await res.json();
            } catch (e) { }

            const panel = document.getElementById('panel-add');
            const tags = getInstalledTags();
            let html = '';

            html += '<div class="section-label">ü§ñ General Models</div>';
            MODEL_CATALOG.general.forEach((model, mi) => {
                html += renderCatalogItem(model, 'general', mi, tags);
            });

            html += '<div class="section-label" style="margin-top:20px">üíª Coder Models</div>';
            MODEL_CATALOG.code.forEach((model, mi) => {
                html += renderCatalogItem(model, 'code', mi, tags);
            });

            panel.innerHTML = html;
        }

        function renderCatalogItem(model, category, idx, installedTags) {
            const id = `cat-${category}-${idx}`;
            // Check if ANY variant is already installed
            const installedVariants = model.variants.filter(v => installedTags.has(v.tag));
            const allInstalled = installedVariants.length > 0;

            let rightHTML = '';
            if (allInstalled) {
                rightHTML = `<div class="catalog-installed-badge">‚úì Installed</div>`;
            } else {
                let variantSelect = '';
                if (model.variants.length > 1) {
                    const opts = model.variants.map((v, vi) =>
                        `<option value="${vi}">${v.label} (${v.ram})</option>`
                    ).join('');
                    variantSelect = `<select class="catalog-variant-select" id="${id}-variant">${opts}</select>`;
                } else {
                    variantSelect = `<select class="catalog-variant-select" id="${id}-variant" style="display:none"><option value="0">${model.variants[0].label}</option></select>
                    <span style="font-size:0.72rem;color:var(--text-muted);text-align:center">${model.variants[0].ram}</span>`;
                }
                rightHTML = `
                    ${variantSelect}
                    <button class="add-model-btn" id="${id}-btn" onclick="installModel('${category}', ${idx}, '${id}')">+ Install</button>
                    <button class="cancel-model-btn" id="${id}-cancel" style="display:none" onclick="cancelInstall('${id}')">‚úï Cancel</button>`;
            }

            return `
                <div class="catalog-item" id="${id}">
                    <div class="catalog-info">
                        <div class="catalog-name">${model.name}</div>
                        <div class="catalog-desc">${model.desc}</div>
                    </div>
                    <div class="catalog-right">
                        ${rightHTML}
                    </div>
                </div>`;
        }

        // Track active installs for cancellation
        const activeInstalls = {};

        async function installModel(category, idx, elId) {
            const model = MODEL_CATALOG[category][idx];
            const variantSelect = document.getElementById(`${elId}-variant`);
            const vi = variantSelect ? parseInt(variantSelect.value) : 0;
            const variant = model.variants[vi];
            const btn = document.getElementById(`${elId}-btn`);
            const cancelBtn = document.getElementById(`${elId}-cancel`);

            // Create AbortController for this install
            const controller = new AbortController();
            activeInstalls[elId] = { controller, tag: variant.tag, category: category };

            btn.disabled = true;
            btn.className = 'add-model-btn installing';
            btn.textContent = '‚è≥ Downloading...';
            if (cancelBtn) cancelBtn.style.display = 'block';

            try {
                // Add to config first
                await fetch('/api/setup/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: model.name,
                        tag: variant.tag,
                        ram: variant.ram,
                        category: category
                    }),
                    signal: controller.signal
                });

                // Pull the model
                const pullRes = await fetch('/api/setup/pull', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag: variant.tag }),
                    signal: controller.signal
                });

                if (pullRes.ok) {
                    btn.className = 'add-model-btn done';
                    btn.textContent = '‚úì Installed';
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    // Reload models endpoint
                    await fetch('/api/models/reload', { method: 'POST' });
                    loadModels();
                } else {
                    const err = await pullRes.json();
                    throw new Error(err.detail || 'Pull failed');
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    btn.className = 'add-model-btn';
                    btn.disabled = false;
                    btn.textContent = '+ Install';
                } else {
                    btn.className = 'add-model-btn';
                    btn.disabled = false;
                    btn.textContent = '‚úó Retry';
                    alert('Failed to install: ' + err.message);
                }
                if (cancelBtn) cancelBtn.style.display = 'none';
            } finally {
                delete activeInstalls[elId];
            }
        }

        async function cancelInstall(elId) {
            const install = activeInstalls[elId];
            if (!install) return;

            const cancelBtn = document.getElementById(`${elId}-cancel`);
            if (cancelBtn) { cancelBtn.textContent = 'Cancelling...'; cancelBtn.disabled = true; }

            // Abort the fetch
            install.controller.abort();

            // Tell the server to kill the process
            try {
                await fetch('/api/setup/cancel-pull', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag: install.tag })
                });
                // Also remove from config since it wasn't fully installed
                await fetch('/api/setup/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag: install.tag, category: install.category })
                });
            } catch (e) { }

            if (cancelBtn) {
                cancelBtn.textContent = '‚úï Cancel';
                cancelBtn.disabled = false;
                cancelBtn.style.display = 'none';
            }
        }

    </script>
</body>

</html>